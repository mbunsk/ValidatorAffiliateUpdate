import { useState } from "react";
import { Button } from "@/components/ui/button";
import { Card, CardContent } from "@/components/ui/card";
import { Download, ArrowDown } from "lucide-react";
import { useToast } from "@/hooks/use-toast";
import jsPDF from "jspdf";

interface SaveResultsProps {
  validationData: {
    idea: string;
    targetCustomer: string;
    problemSolved: string;
    feedback: string;
  };
}

export default function SaveResults({ validationData }: SaveResultsProps) {
  const [generating, setGenerating] = useState(false);
  const { toast } = useToast();

  const generatePDF = async () => {
    setGenerating(true);
    try {
      // Create a clean text version of the feedback - thorough HTML cleaning
      let cleanFeedback = validationData.feedback
        // Remove code blocks and markdown artifacts first
        .replace(/```html/gi, '')
        .replace(/```/g, '')
        .replace(/`/g, '')
        // Replace HTML elements with proper spacing
        .replace(/<div[^>]*>/gi, '\n\n')
        .replace(/<\/div>/gi, '')
        .replace(/<h3[^>]*>/gi, '\n\n')
        .replace(/<\/h3>/gi, ': ')
        .replace(/<h4[^>]*>/gi, '\n\n')
        .replace(/<\/h4>/gi, ': ')
        .replace(/<p[^>]*>/gi, '\n')
        .replace(/<\/p>/gi, '')
        .replace(/<ul[^>]*>/gi, '\n')
        .replace(/<\/ul>/gi, '')
        .replace(/<li[^>]*>/gi, '\nâ€¢ ')
        .replace(/<\/li>/gi, '')
        .replace(/<strong[^>]*>/gi, '')
        .replace(/<\/strong>/gi, '')
        .replace(/<em[^>]*>/gi, '')
        .replace(/<\/em>/gi, '')
        // Remove any remaining HTML tags
        .replace(/<[^>]*>/g, '')
        // Clean HTML entities
        .replace(/&nbsp;/g, ' ')
        .replace(/&amp;/g, '&')
        .replace(/&lt;/g, '<')
        .replace(/&gt;/g, '>')
        .replace(/&quot;/g, '"')
        .replace(/&#39;/g, "'")
        .replace(/&hellip;/g, '...')
        // Clean up excessive whitespace
        .replace(/\n{3,}/g, '\n\n')
        .replace(/\s{2,}/g, ' ')
        .trim();
      
      // Create PDF
      const doc = new jsPDF();
      const pageWidth = doc.internal.pageSize.width;
      const pageHeight = doc.internal.pageSize.height;
      const margin = 20;
      const lineHeight = 7;
      let yPosition = margin;

      // Title
      doc.setFontSize(18);
      doc.setFont("helvetica", "bold");
      doc.text("STARTUP IDEA VALIDATION REPORT", pageWidth / 2, yPosition, { align: "center" });
      yPosition += lineHeight * 2;

      // Subtitle
      doc.setFontSize(12);
      doc.setFont("helvetica", "normal");
      doc.text("Generated by ValidatorAI.com", pageWidth / 2, yPosition, { align: "center" });
      yPosition += lineHeight;
      doc.text(`Date: ${new Date().toLocaleDateString()}`, pageWidth / 2, yPosition, { align: "center" });
      yPosition += lineHeight * 3;

      // Content sections
      const sections = [
        { title: "IDEA", content: validationData.idea },
        { title: "TARGET CUSTOMER", content: validationData.targetCustomer },
        { title: "PROBLEM SOLVED", content: validationData.problemSolved },
        { title: "VAL'S ANALYSIS", content: cleanFeedback }
      ];

      sections.forEach((section) => {
        // Check if we need a new page
        if (yPosition > pageHeight - 40) {
          doc.addPage();
          yPosition = margin;
        }

        // Section title
        doc.setFontSize(14);
        doc.setFont("helvetica", "bold");
        doc.text(section.title, margin, yPosition);
        yPosition += lineHeight * 1.5;

        // Section content
        doc.setFontSize(10);
        doc.setFont("helvetica", "normal");
        const splitText = doc.splitTextToSize(section.content, pageWidth - 2 * margin);
        splitText.forEach((line: string) => {
          if (yPosition > pageHeight - 20) {
            doc.addPage();
            yPosition = margin;
          }
          doc.text(line, margin, yPosition);
          yPosition += lineHeight;
        });
        yPosition += lineHeight;
      });

      // Footer
      doc.setFontSize(8);
      doc.setFont("helvetica", "italic");
      const footerText = "Generated by ValidatorAI.com - Your AI Startup Mentor";
      doc.text(footerText, pageWidth / 2, pageHeight - 10, { align: "center" });

      // Save the PDF with a short, unique name
      const ideaWords = validationData.idea.split(' ').slice(0, 3).join('-').replace(/[^a-zA-Z0-9-]/g, '').toLowerCase();
      const timestamp = Date.now().toString().slice(-6); // Last 6 digits for uniqueness
      doc.save(`val-report-${ideaWords}-${timestamp}.pdf`);

      toast({
        title: "PDF Downloaded!",
        description: "Your validation report has been saved as a PDF",
      });
    } catch (error) {
      toast({
        title: "Error",
        description: "Failed to generate PDF report",
        variant: "destructive",
      });
    } finally {
      setGenerating(false);
    }
  };

  return (
    <Card className="shadow-lg border-2 border-blue-500/20 bg-gradient-to-r from-blue-500/10 to-green-500/10">
      <CardContent className="p-6">
        <h4 className="text-lg font-bold text-blue-600 mb-4 flex items-center gap-2">
          ðŸ’¾ Save Your Results
        </h4>
        <p className="text-sm text-foreground/80 mb-4">
          Download your complete validation report to keep and share with others!
        </p>
        
        <div className="flex justify-center">
          <Button
            onClick={generatePDF}
            disabled={generating}
            size="lg"
            className="bg-blue-600 hover:bg-blue-700"
          >
            <Download className="w-4 h-4 mr-2" />
{generating ? "Generating PDF..." : "Download PDF Report"}
          </Button>
        </div>
        
        {/* Encouragement section */}
        <div className="mt-8 text-center p-4 bg-gradient-to-r from-primary/10 to-accent/10 rounded-xl border border-primary/20">
          <div className="mb-4"></div>
          <div className="mb-4"></div>
          <p className="text-foreground/80 text-lg mb-2">
            <span className="font-semibold">Great work exploring your idea!</span> ðŸŽ‰
          </p>
          <p className="text-foreground/70 mb-3">
            Here is the next step to validate. Create a free landing page mockup to visualize your idea clearly. It's free.
          </p>
          <div className="flex justify-center">
            <ArrowDown className="w-6 h-6 text-primary animate-bounce" />
          </div>
        </div>
      </CardContent>
    </Card>
  );
}